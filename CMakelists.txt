cmake_minimum_required(VERSION 3.10)

project(libutils LANGUAGES CXX)

option(BDUIL_TEST "编译测试程序" OFF)
option(BDUIL_UNITEST "编译GTEST单元测试" OFF)

include("cmake/BuildModule.cmake")

# add all submodules
file(GLOB _MODULE_LIST LIST_DIRECTORIES TRUE "libs/*")
foreach(_SUB IN LISTS _MODULE_LIST)
	add_subdirectory(${_SUB})
endforeach()

add_library(
	libutils_all
	$<TARGET_OBJECTS:libutils::daemon>
	$<TARGET_OBJECTS:libutils::thread-slice>
	$<TARGET_OBJECTS:libutils::time>
	$<TARGET_OBJECTS:libutils::timer-task>
)
target_link_libraries(libutils_all PUBLIC libutils::template PUBLIC libutils::daemon libutils::thread-slice libutils::time libutils::timer-task)
add_library(${PROJECT_NAME}::libutils_all ALIAS libutils_all)

install(TARGETS libutils_all LIBRARY)

# build test
if(BDUIL_TEST)
	set(TEST_PROJECT ${PROJECT_NAME}-test)

	add_executable(${TEST_PROJECT} "tests/main.cpp")
	target_link_libraries(${TEST_PROJECT} PRIVATE libutils::libutils_all)
	target_compile_options(${TEST_PROJECT} PRIVATE "$<$<C_COMPILER_ID:MSVC>:/utf-8>" "$<$<CXX_COMPILER_ID:MSVC>:/utf-8>")
endif()

if(BDUIL_UNITEST)
	set(TEST_PROJECT ${PROJECT_NAME}-unitest)
	
	find_package(GTest CONFIG REQUIRED)
	add_executable(${TEST_PROJECT} "tests/TestThreadSlice.cpp" "tests/TestTimerTask.cpp" "tests/TestDeamon.cpp")
	target_link_libraries(${TEST_PROJECT} PRIVATE GTest::gtest_main)

	target_link_libraries(${TEST_PROJECT} PRIVATE libutils::libutils_all)
	target_compile_options(${TEST_PROJECT} PRIVATE "$<$<C_COMPILER_ID:MSVC>:/utf-8>" "$<$<CXX_COMPILER_ID:MSVC>:/utf-8>")
endif()

